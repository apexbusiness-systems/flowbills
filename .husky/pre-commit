#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# FlowAi LLM Protection - Pre-commit Hook
echo "üîí FlowAi Pre-commit: Checking for protected file changes..."

# Check if staged files include protected LLM directories
if git diff --cached --name-only | grep -E '^(llm/|supabase/functions/llm/|supabase/functions/oil-gas-assistant/|rag/)'; then
  echo "‚ùå SECURITY: LLM area is locked and requires CTO approval"
  echo "Files in the following directories require special authorization:"
  echo "  - llm/"
  echo "  - supabase/functions/llm/"
  echo "  - supabase/functions/oil-gas-assistant/"
  echo "  - rag/"
  echo ""
  echo "Please:"
  echo "1. Seek CTO team approval before making these changes"
  echo "2. Use 'git commit --no-verify' ONLY with explicit CTO permission"
  echo "3. Ensure all changes are documented and reviewed"
  exit 1
fi

# P10: Edge Function Pre-Commit Hygiene
if git diff --cached --name-only | grep -E '^supabase/functions/.*\.ts$'; then
  echo "üîç Running Edge Function quality checks..."
  
  # Check if deno is available
  if ! command -v deno &> /dev/null; then
    echo "‚ö†Ô∏è  Deno not found - skipping format/lint/check"
  else
    # Get changed function files
    CHANGED_FUNCTIONS=$(git diff --cached --name-only | grep -E '^supabase/functions/.*\.ts$')
    
    # Run deno fmt check
    echo "  ‚Üí Format check..."
    for file in $CHANGED_FUNCTIONS; do
      if ! deno fmt --check "$file" &>/dev/null; then
        echo "‚ùå Format check failed: $file"
        echo "   Run: deno fmt $file"
        exit 1
      fi
    done
    
    # Run deno lint
    echo "  ‚Üí Lint check..."
    for file in $CHANGED_FUNCTIONS; do
      if ! deno lint "$file" &>/dev/null; then
        echo "‚ùå Lint check failed: $file"
        echo "   Run: deno lint $file"
        exit 1
      fi
    done
    
    # Run deno check for index.ts files
    echo "  ‚Üí Type check..."
    for file in $CHANGED_FUNCTIONS; do
      if [[ "$file" == */index.ts ]]; then
        if ! deno check --import-map=./supabase/import_map.json "$file" &>/dev/null; then
          echo "‚ùå Type check failed: $file"
          echo "   Run: deno check --import-map=./supabase/import_map.json $file"
          exit 1
        fi
      fi
    done
    
    echo "  ‚úì All Edge Function checks passed"
  fi
fi

echo "‚úÖ Pre-commit check passed"