name: LLM Integrity Protection
on: 
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  llm-protection:
    runs-on: ubuntu-latest
    name: Protect Oil & Gas LLM Configuration
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for unauthorized LLM changes
        run: |
          set -e
          echo "ğŸ”’ Checking for changes to protected LLM files..."

          # Get changed files - use PR base for PRs, HEAD~1 for pushes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            CHANGED=$(git diff --name-only "$BASE_SHA" HEAD -- llm/ supabase/functions/llm/ supabase/functions/oil-gas-assistant/ rag/ 2>/dev/null || echo "")
          else
            # For pushes, check if HEAD~1 exists (initial commits won't have it)
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              CHANGED=$(git diff --name-only HEAD~1 HEAD -- llm/ supabase/functions/llm/ supabase/functions/oil-gas-assistant/ rag/ 2>/dev/null || echo "")
            else
              echo "âœ… Initial commit - no LLM change comparison needed"
              CHANGED=""
            fi
          fi
          
          if [ -n "$CHANGED" ]; then
            echo "âš ï¸  LLM files changed:"
            echo "$CHANGED"
            
            # For PR events, check if CTO approval is present
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              # Check if user is authorized or has CTO approval
              if [[ "${{ github.event.pull_request.user.login }}" != "cto-bot" ]] && \
                 ! echo "${{ github.event.pull_request.requested_reviewers.*.login }}" | grep -qi "cto"; then
                echo "âŒ SECURITY: LLM changes require CTO team approval"
                echo "Please request review from @cto-team"
                exit 1
              fi
            fi
          else
            echo "âœ… No protected LLM files changed"
          fi

      - name: Verify LLM manifest integrity
        if: hashFiles('llm/manifest.json') != ''
        run: |
          echo "ğŸ” Verifying LLM manifest structure and critical fields..."
          
          # Verify manifest has required fields (integrity check without self-referential hash)
          PROVIDER=$(jq -r '.provider // empty' llm/manifest.json)
          MODEL=$(jq -r '.model_id // empty' llm/manifest.json)
          ADAPTER=$(jq -r '.adapter // empty' llm/manifest.json)
          
          if [ -z "$PROVIDER" ] || [ -z "$MODEL" ] || [ -z "$ADAPTER" ]; then
            echo "âŒ SECURITY: LLM manifest missing required fields!"
            echo "provider: $PROVIDER, model_id: $MODEL, adapter: $ADAPTER"
            exit 1
          fi
          
          # Verify expected values haven't been tampered with
          if [ "$PROVIDER" != "openai" ] || [ "$MODEL" != "gpt-4o" ] || [ "$ADAPTER" != "energy-lora-v1" ]; then
            echo "âŒ SECURITY: LLM manifest critical values changed!"
            echo "Expected: openai/gpt-4o/energy-lora-v1"
            echo "Actual: $PROVIDER/$MODEL/$ADAPTER"
            exit 1
          fi
          
          echo "âœ… LLM manifest integrity verified (provider=$PROVIDER, model=$MODEL, adapter=$ADAPTER)"

      - name: Validate LLM environment consistency
        run: |
          echo "ğŸ”§ Checking LLM environment variable consistency..."
          
          # Check if required env vars are documented
          if ! grep -q "LLM_PROVIDER" .env.example 2>/dev/null; then
            echo "âš ï¸  LLM_PROVIDER not found in .env.example"
          fi
          
          if ! grep -q "LLM_LOCK" .env.example 2>/dev/null; then
            echo "âš ï¸  LLM_LOCK not found in .env.example"
          fi
          
          echo "âœ… Environment validation complete"

      - name: Security scan for hardcoded secrets
        run: |
          echo "ğŸ” Scanning for hardcoded API keys in LLM files..."
          
          # Check for potential hardcoded secrets (basic patterns)
          if grep -r -i "api[_-]key\s*=\s*['\"][^'\"]*['\"]" llm/ supabase/functions/llm/ supabase/functions/oil-gas-assistant/ 2>/dev/null; then
            echo "âŒ SECURITY: Potential hardcoded API key detected"
            exit 1
          fi
          
          if grep -r -E "(sk-|pk-)[a-zA-Z0-9]{32,}" llm/ supabase/functions/llm/ supabase/functions/oil-gas-assistant/ 2>/dev/null; then
            echo "âŒ SECURITY: Potential OpenAI API key pattern detected"
            exit 1
          fi
          
          echo "âœ… No hardcoded secrets found"